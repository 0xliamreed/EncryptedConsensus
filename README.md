# EncryptedConsensus

Privacy-preserving predictions built on FHE. Users create a prediction with 2 to 4 options, submit encrypted votes, and keep option counts encrypted on-chain until the creator ends the prediction and reveals results.

## Overview

EncryptedConsensus is a prediction dapp that uses fully homomorphic encryption (FHE) so votes and running totals stay private while still being tallied on-chain. The outcome becomes publicly decryptable only when the prediction is ended.

## The Problem

Traditional on-chain predictions expose votes and interim results in real time, enabling:
- Strategic voting based on current counts.
- Vote-buying and coercion.
- Privacy leakage about user preferences.
- Fragile "commit-reveal" schemes that require extra transactions and coordination.

## The Solution

This project uses Zama FHEVM tooling to keep both votes and per-option counts encrypted on-chain. Users submit encrypted choices, the contract aggregates encrypted totals, and only the final results are made publicly decryptable after the prediction ends.

## Core Advantages

- Privacy by default for votes and interim totals.
- Encrypted aggregation without off-chain tallying.
- Clear separation between private voting and public result reveal.
- Simple user flow: one encrypted vote, one on-chain tally.

## Key Features

- Create predictions with 2 to 4 options.
- Encrypted voting for any active prediction.
- Encrypted per-option counts stored on-chain.
- Public decryption of results only after closing.

## Technology Stack

- Smart contracts: Hardhat + Zama FHEVM tooling
- Front end: React + Vite + RainbowKit
- Read calls: viem
- Write calls: ethers
- Package manager: npm

## Architecture Summary

1. Prediction creation stores metadata and initializes encrypted counts.
2. Voting encrypts user choice with FHE and submits a ciphertext.
3. Contract updates encrypted tallies on-chain.
4. Closing a prediction enables public decryption of results.

## Project Structure

- Contracts: `contracts/`
- Deploy scripts: `deploy/`
- Tasks: `tasks/`
- Tests: `test/`
- Front end: `app/`
- Zama docs: `docs/`
- Deployments: `deployments/`

## Setup

### Prerequisites

- Node.js 20+
- npm 7+

### Install

```bash
npm install
```

### Environment Configuration (Contracts Only)

Create a `.env` file at the repo root with:

```bash
# private key without 0x prefix
PRIVATE_KEY=your_private_key
INFURA_API_KEY=your_infura_key
ETHERSCAN_API_KEY=your_etherscan_key
```

Notes:
- Deploy with a private key only. Do not use a mnemonic.
- The front end must not use environment variables.

### Compile and Test

```bash
npm run compile
npm test
```

### Run Tasks

```bash
npx hardhat help
```

## Deployment Workflow

Follow this order:
1. Start a local node.
   ```bash
   npx hardhat node
   ```
2. Deploy to the local node.
   ```bash
   npx hardhat deploy --network localhost
   ```
3. Run tasks and tests until they pass.
4. Deploy to Sepolia with the configured private key.
   ```bash
   npx hardhat deploy --network sepolia
   npx hardhat verify --network sepolia <DEPLOYED_ADDRESS>
   ```

## Front-End Integration Notes

- Use the ABI generated by the contract build in `deployments/sepolia`.
- Do not import JSON files in the front end; paste the ABI array into a TS module.
- Use viem for read calls and ethers for write calls.
- Do not use Tailwind.
- Do not use localstorage.
- Do not use localhost networks in the front end.

## Security and Privacy Notes

- Votes and option counts remain encrypted until a prediction is closed.
- View functions avoid `msg.sender` for address lookup.
- Result decryption is gated by an explicit on-chain close action.
- The privacy model depends on FHEVM guarantees and correct relayer usage.

## Future Roadmap

- Add prediction metadata validation and richer descriptions.
- Add pagination and filters for large prediction lists.
- Add safer lifecycle state checks and guardrails for invalid transitions.
- Add analytics dashboards that only use publicly revealed results.
- Add gas and UX optimizations for high-volume predictions.

## License

See `LICENSE`.
